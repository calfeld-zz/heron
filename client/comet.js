// Generated by CoffeeScript 1.6.3
(function() {
  var Heron, c_max_reconnect_retry, receive, reconnect;

  Heron = this.Heron != null ? this.Heron : this.Heron = {};

  c_max_reconnect_retry = 1;

  reconnect = function() {
    receive.call(this);
    jQuery.get(this._.path + "/flush", {
      client_id: this._.client_id
    });
    return null;
  };

  receive = function() {
    var failure,
      _this = this;
    if (!this._.connected) {
      return null;
    }
    failure = function() {
      var _base;
      if (!_this._.connected) {
        return;
      }
      if (_this._.reconnect_retry < c_max_reconnect_retry) {
        _this._.verbose("disconnected; trying to reconnect.");
        ++_this._.reconnect_retry;
        return setTimeout(function() {
          return reconnect.call(_this);
        }, 0);
      } else {
        _this._.verbose("disconnected; retry count exceeded.");
        _this._.connected = false;
        _this._.current_receive = null;
        return typeof (_base = _this._).on_lost === "function" ? _base.on_lost() : void 0;
      }
    };
    this._.current_receive = jQuery.get(this._.path + "/receive", {
      client_id: this._.client_id
    }, function(data, textStatus, transport) {
      var _base;
      if (!_this._.connected) {
        return;
      }
      if (transport.status !== 200) {
        return failure();
      } else if (_this._.connected) {
        if (_this._.reconnect_retry > 0) {
          _this._.verbose("reconnected.");
          _this._.reconnect_retry = 0;
        }
        if (transport.responseText !== "") {
          _this._.verbose(transport.responseText);
          if (typeof (_base = _this._).on_message === "function") {
            _base.on_message(transport.responseText, _this);
          }
        }
        return setTimeout(function() {
          return receive.call(_this);
        }, 0);
      }
    }).fail(failure);
    return null;
  };

  Heron.Comet = (function() {
    function Comet(config) {
      var _ref, _ref1, _ref2,
        _this = this;
      this._ = {
        path: (_ref = config.path) != null ? _ref : "/comet",
        on_message: config.on_message,
        on_verbose: config.on_verbose,
        on_loss: config.on_loss,
        on_connect: config.on_connect,
        on_disconnect: config.on_disconnect,
        on_exception: (_ref1 = config.on_exception) != null ? _ref1 : function(e, text, comet) {
          return _this._.verbose("Exception: " + text);
        },
        client_id: (_ref2 = config.client_id) != null ? _ref2 : Heron.Util.generate_id(),
        connected: false,
        verbose: function(s) {
          var _base;
          return typeof (_base = _this._).on_verbose === "function" ? _base.on_verbose("comet: " + s, _this) : void 0;
        },
        reconnect_retry: 0
      };
      this._.verbose("initialized");
    }

    Comet.prototype.client_id = function() {
      return this._.client_id;
    };

    Comet.prototype.connected = function() {
      return this._.connected;
    };

    Comet.prototype.connect = function() {
      var _this = this;
      jQuery.get(this._.path + "/connect", {
        client_id: this._.client_id
      }, function() {
        var _base;
        _this._.connected = true;
        receive.call(_this);
        _this._.verbose("connected");
        return typeof (_base = _this._).on_connect === "function" ? _base.on_connect(_this) : void 0;
      });
      return this;
    };

    Comet.prototype.disconnect = function() {
      var _ref,
        _this = this;
      if (this._.connected) {
        this._.connected = false;
        if ((_ref = this._.current_receive) != null) {
          _ref.abort();
        }
        jQuery.get(this._.path + "/disconnect", {
          client_id: this._.client_id
        }, function() {
          _this._.verbose("disconnected");
          return _this._.on_disconnect(_this);
        });
      }
      return this;
    };

    return Comet;

  })();

}).call(this);
